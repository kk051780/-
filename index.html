<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Video AI Summarizer (Audio+Vision) - One File</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b0f14;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#22c55e;--warn:#f59e0b;--error:#ef4444;}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px;}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
  .title{font-size:20px;font-weight:700;margin:0 0 8px}
  label{font-size:12px;color:var(--muted)}
  input[type="text"],textarea{width:100%;background:#0f172a;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:10px;outline:none}
  textarea{height:160px;resize:vertical}
  button{appearance:none;border:0;border-radius:999px;background:var(--accent);color:#052e16;font-weight:700;padding:12px 18px;cursor:pointer}
  button.secondary{background:#334155;color:#e5e7eb}
  .drop{border:2px dashed #334155;border-radius:16px;padding:24px;text-align:center;color:var(--muted)}
  .drop.drag{border-color:var(--accent);color:#a7f3d0;background:#052e16}
  .bad{color:var(--error)}
  .warn{color:var(--warn)}
  .pill{display:inline-block;background:#0b3b2d;color:#a7f3d0;border:1px solid #14532d;border-radius:999px;padding:4px 10px;margin:2px 4px 0 0;font-size:11px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
  .thumb{border:1px solid #374151;border-radius:8px;overflow:hidden;background:#0f172a}
  .thumb img{width:100%;display:block}
  .small{font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .progress{height:8px;background:#1f2937;border-radius:999px;overflow:hidden}
  .progress > span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4);}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <div class="card" style="flex:1 1 360px">
      <h2 class="title">設定</h2>
      <label>OpenAI API Key（高品質モード用。未入力ならローカル簡易モード）</label>
      <input id="apiKey" type="text" placeholder="sk-... を貼り付け" />
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="analyzeBtn">自動解析</button>
        <button class="secondary" id="clearBtn">リセット</button>
      </div>
      <p class="small" style="margin-top:10px">
        ・**動画をそのまま**解析して <b>音声(ASR)+画像(OCR/ビジョン)</b> を要約します。<br/>
        ・APIキー無し=ローカル簡易（OCR中心）。APIキー有り=<b>GPT高品質</b>（Whisper/GPT-4o-mini）。<br/>
        ・対応: mp4/webm/m4v/mov（mkv/ts/aviは失敗時に自動で音声抽出を試行）。<br/>
      </p>
    </div>

    <div class="card" style="flex:2 1 520px">
      <h2 class="title">動画をドロップ</h2>
      <div id="drop" class="drop">ここに動画ファイルをドラッグ＆ドロップ<br/><span class="small">またはクリックして選択</span></div>
      <input id="fileInput" type="file" accept="video/*" style="display:none"/>
      <div style="margin-top:10px">
        <div class="progress" id="prog" style="display:none"><span style="width:0%"></span></div>
        <div id="status" class="small"></div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="card" style="flex:1 1 340px">
      <h3 class="title">要約（日本語）</h3>
      <textarea id="summary" placeholder="解析するとここに要約が出ます"></textarea>
      <div style="margin-top:8px">
        <button class="secondary" id="copySummary">要約をコピー</button>
      </div>
    </div>

    <div class="card" style="flex:1 1 340px">
      <h3 class="title">音声→文字（ASR）抜粋</h3>
      <textarea id="transcript" placeholder="音声の文字起こし（抜粋）"></textarea>
      <div class="small">※全文はJSONダウンロードで取得可能</div>
    </div>

    <div class="card" style="flex:1 1 340px">
      <h3 class="title">OCR/キーワード</h3>
      <div id="keywords"></div>
    </div>
  </div>

  <div class="card">
    <h3 class="title">サムネイル（自動抽出フレーム）</h3>
    <div class="grid" id="frames"></div>
  </div>

  <div class="row">
    <div class="card" style="flex:1 1 340px">
      <h3 class="title">重要シーン（タイムライン）</h3>
      <div id="timeline" class="mono small"></div>
    </div>
    <div class="card" style="flex:2 1 520px">
      <h3 class="title">解析JSON</h3>
      <textarea id="jsonOut" class="mono" placeholder="{ ... }"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="secondary" id="downloadJson">JSONを保存</button>
      </div>
    </div>
  </div>
</div>

<!-- 必要時のみ読み込む（Tesseractは軽いので先読み） -->
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
  // ====== 便利関数 ======
  const $ = (id)=>document.getElementById(id);
  const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));
  const setStatus = (msg, type="")=>{
    const s=$("status"); s.innerHTML = msg;
    s.className = "small "+(type||"");
  }
  const setProgress = (p)=>{
    const bar = $("prog"); bar.style.display="block";
    bar.querySelector("span").style.width = Math.max(0,Math.min(100,p))+"%";
  }
  const resetProgress = ()=>{
    $("prog").style.display="none";
    setStatus("");
  }
  const formatTime = (sec)=>{
    sec=Math.max(0,Math.round(sec));
    const h=String(Math.floor(sec/3600)).padStart(2,"0");
    const m=String(Math.floor((sec%3600)/60)).padStart(2,"0");
    const s=String(sec%60).padStart(2,"0");
    return (h==="00"?`${m}:${s}`:`${h}:${m}:${s}`);
  }

  // ====== ドロップ/選択 ======
  let file=null;
  const drop=$("drop");
  drop.addEventListener("dragover",e=>{e.preventDefault(); drop.classList.add("drag")});
  drop.addEventListener("dragleave",()=> drop.classList.remove("drag"));
  drop.addEventListener("drop",(e)=>{
    e.preventDefault(); drop.classList.remove("drag");
    if(e.dataTransfer.files?.length){ handleFile(e.dataTransfer.files[0]); }
  });
  drop.addEventListener("click", ()=> $("fileInput").click());
  $("fileInput").addEventListener("change",(e)=>{ if(e.target.files?.length) handleFile(e.target.files[0]); });

  function handleFile(f){
    file=f;
    drop.textContent = `${file.name} を受け取りました (${(file.size/1024/1024).toFixed(1)}MB)`;
  }

  // ====== フレーム抽出（ブラウザ内） ======
  async function extractFrames(file, stepSec=8, maxFrames=16){
    return new Promise(async (resolve,reject)=>{
      try{
        const url = URL.createObjectURL(file);
        const v = document.createElement("video");
        v.preload="auto";
        v.src = url;
        v.muted=true;
        v.playsInline=true;
        await v.play().catch(()=>{});  // iOS対策（無音再生）
        await new Promise(r=> v.addEventListener("loadedmetadata", r, {once:true}));
        v.pause();
        const dur = v.duration || 0;
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 960; canvas.height = Math.round(960*(v.videoHeight||540)/(v.videoWidth||960));

        const frames=[], times=[];
        const step = Math.max(2, stepSec);
        const n = Math.min(maxFrames, Math.max(3, Math.floor(dur/step)+1));
        for(let i=0;i<n;i++){
          const t = Math.min(dur-0.2, Math.max(0, i*step));
          v.currentTime = t;
          await new Promise(r=> v.addEventListener("seeked", r, {once:true}));
          ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
          const data = canvas.toDataURL("image/jpeg", 0.7);
          frames.push(data);
          times.push(t);
          setProgress(Math.round((i+1)/n*30)); // 0-30%
        }
        URL.revokeObjectURL(url);
        resolve({frames, times, duration:dur});
      }catch(e){ reject(e); }
    });
  }

  // ====== ローカルOCR（Tesseract.js） ======
  async function ocrFrames(frames){
    const worker = await Tesseract.createWorker("jpn+eng");
    const texts=[];
    for(let i=0;i<frames.length;i++){
      const r = await worker.recognize(frames[i]);
      texts.push(r.data.text||"");
      setProgress(30 + Math.round((i+1)/frames.length*20)); // 30-50%
    }
    await worker.terminate();
    return texts;
  }

  // ====== Whisper（OpenAI）で音声文字起こし ======
  async function transcribeWithOpenAI(apiKey, fileToSend){
    const fd = new FormData();
    fd.append("file", fileToSend, fileToSend.name || "audio_or_video");
    fd.append("model", "whisper-1");
    // fd.append("language","ja"); // 自動検出に任せたい場合はコメントアウト

    const res = await fetch("https://api.openai.com/v1/audio/transcriptions", {
      method:"POST",
      headers:{ "Authorization":"Bearer "+apiKey },
      body: fd
    });
    if(!res.ok){
      const t=await res.text(); throw new Error("ASR失敗: "+t);
    }
    const json = await res.json();
    return json.text || "";
  }

  // ====== 失敗時のみ ffmpeg.wasm で音声抽出（mp3） ======
  async function ensureFFmpeg(){
    if(window._ffmpegReady) return;
    // 動的ロード（必要時のみ）: 注意: 一部環境ではfile://でCOOP/COEP制約あり
    await new Promise((ok,ng)=>{
      const s=document.createElement("script");
      s.src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/ffmpeg.min.js";
      s.onload=ok; s.onerror=ng; document.head.appendChild(s);
    });
    window._ffmpegReady=true;
  }
  async function extractAudioMp3(file){
    await ensureFFmpeg();
    const { createFFmpeg } = FFmpeg;
    const ffmpeg = createFFmpeg({
      log: false,
      corePath: "https://unpkg.com/@ffmpeg/core@0.12.7/dist/ffmpeg-core.js",
    });
    setStatus("音声抽出(変換)を初期化中…");
    await ffmpeg.load();
    ffmpeg.FS("writeFile", "input", new Uint8Array(await file.arrayBuffer()));
    setStatus("音声抽出を実行中…");
    await ffmpeg.run("-i","input","-vn","-ac","1","-ar","16000","-b:a","64k","audio.mp3");
    const out = ffmpeg.FS("readFile","audio.mp3");
    const blob = new Blob([out.buffer], {type:"audio/mpeg"});
    return new File([blob], "audio.mp3", {type:"audio/mpeg"});
  }

  // ====== GPT-4o-mini で画像+ASRの統合要約 ======
  async function summarizeWithGPT(apiKey, transcript, frames, times){
    // フレーム多すぎると高コスト ⇒ 最大12枚
    const limit = Math.min(12, frames.length);
    const content = [
      {type:"text", text:
`あなたは映像と音声を統合して、視聴者向けの簡潔な日本語サマリーを作るアシスタントです。
出力は以下のJSONにしてください:
{
 "summary": "全体要約(日本語)",
 "key_points": ["箇条書き5-8個"],
 "timeline": [{"t":"mm:ss","event":"見どころ"}...],
 "keywords": ["重要語"],
 "lang":"検出言語(ja/en/...)" }`
      }
    ];
    for(let i=0;i<limit;i++){
      content.push({type:"image_url", image_url:{url: frames[i]}});
    }
    content.push({type:"text", text: "以下は音声の要約用テキストです（誤変換は補正可）:\n---\n"+transcript.slice(0,8000)});

    const body = {
      model: "gpt-4o-mini",
      messages: [
        {role:"system", content:"Be concise. Respond in JSON only. Japanese output."},
        {role:"user", content}
      ],
      temperature: 0.4,
      max_tokens: 900
    };
    const res = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+apiKey,
        "Content-Type":"application/json"
      },
      body: JSON.stringify(body)
    });
    if(!res.ok){ const t=await res.text(); throw new Error("要約失敗: "+t); }
    const json = await res.json();
    // 返答はJSON文字列のはず
    let txt = json.choices?.[0]?.message?.content?.trim()||"{}";
    // ガード: 先頭や末尾にコードフェンスが来た場合の剥がし
    txt = txt.replace(/^```json/,"").replace(/```$/,"").trim();
    return JSON.parse(txt);
  }

  // ====== ローカル簡易サマリ（APIキー無し用） ======
  function simpleLocalSummary(ocrTexts){
    const text = ocrTexts.join("\n").replace(/\s+/g," ").trim();
    const words = text.toLowerCase().replace(/[^a-z0-9\u3040-\u30ff\u4e00-\u9faf]+/g," ").split(" ").filter(w=>w.length>=2);
    const freq = {};
    words.forEach(w=> freq[w]=(freq[w]||0)+1);
    const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,12).map(([w])=>w);
    const summary = (text? "画面内テキストを中心に要約（ローカル簡易）:\n- "+top.slice(0,5).join(" / "): "十分な文字情報が検出できませんでした。");
    return { summary, keywords: top, timeline: [] };
  }

  // ====== 解析ボタン ======
  $("analyzeBtn").addEventListener("click", async ()=>{
    if(!file){ setStatus("先に動画をドロップ/選択してください","warn"); return; }
    resetProgress();
    $("summary").value=""; $("transcript").value=""; $("keywords").innerHTML="";
    $("frames").innerHTML=""; $("timeline").innerHTML=""; $("jsonOut").value="";
    setStatus("フレーム抽出を開始…"); setProgress(5);

    try{
      // 1) フレーム抽出
      const {frames, times, duration} = await extractFrames(file, 8, 16);
      const framesEl = $("frames");
      frames.forEach((f,i)=>{
        const d=document.createElement("div"); d.className="thumb";
        d.innerHTML = `<img src="${f}"/><div class="small" style="padding:6px">${formatTime(times[i])}</div>`;
        framesEl.appendChild(d);
      });

      // 2) OCR
      setStatus("OCR実行中…"); setProgress(35);
      const ocrTexts = await ocrFrames(frames);
      const kwEl = $("keywords");
      const joined = ocrTexts.join("\n");
      (Array.from(new Set(joined.split(/\s+/).filter(x=>x&&x.length>2))).slice(0,30))
        .forEach(k=>{ const s=document.createElement("span"); s.className="pill"; s.textContent=k; kwEl.appendChild(s); });

      const apiKey = $("apiKey").value.trim();

      let transcript = "";
      let json = {};
      if(apiKey){
        // 3) WhisperでASR
        setStatus("音声文字起こし中（GPT高品質）…"); setProgress(55);
        try{
          transcript = await transcribeWithOpenAI(apiKey, file);
        }catch(e){
          // mkv/ts/aviなどで失敗したらmp3抽出→再挑戦
          setStatus("直接ASRに失敗。音声抽出→再挑戦します…","warn");
          const mp3 = await extractAudioMp3(file);
          transcript = await transcribeWithOpenAI(apiKey, mp3);
        }
        $("transcript").value = (transcript||"").slice(0,3000);

        // 4) GPT-4o-miniで統合要約
        setStatus("音声+画像の統合要約（GPT）…"); setProgress(75);
        json = await summarizeWithGPT(apiKey, transcript, frames, times);

        // 5) 表示
        $("summary").value = json.summary || "";
        $("jsonOut").value = JSON.stringify({
          meta:{file:file.name,size:file.size,duration},
          transcript,
          ocrTexts,
          visionSummary: json
        }, null, 2);
        const tl = json.timeline||[];
        $("timeline").innerHTML = tl.map(x=>`• ${x.t}  ${x.event}`).join("<br/>");
        setStatus("完了！",""); setProgress(100);
      }else{
        // ローカル簡易版
        setStatus("ローカル簡易要約を生成…"); setProgress(75);
        const s = simpleLocalSummary(ocrTexts);
        $("summary").value = s.summary;
        $("jsonOut").value = JSON.stringify({
          meta:{file:file.name,size:file.size,duration, mode:"local-simple"},
          transcript:"",
          ocrTexts,
          visionSummary:s
        }, null, 2);
        setStatus("完了！（ローカル簡易）"); setProgress(100);
      }
    }catch(err){
      console.error(err);
      setStatus("エラー: "+(err.message||err), "bad");
    }
  });

  $("clearBtn").addEventListener("click", ()=>{
    file=null; $("fileInput").value="";
    drop.innerHTML='ここに動画ファイルをドラッグ＆ドロップ<br/><span class="small">またはクリックして選択</span>';
    $("summary").value=""; $("transcript").value="";
    $("keywords").innerHTML=""; $("frames").innerHTML="";
    $("timeline").innerHTML=""; $("jsonOut").value="";
    resetProgress();
  });
  $("copySummary").addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText($("summary").value||""); setStatus("要約をコピーしました"); }
    catch{ setStatus("クリップボードにコピーできませんでした","warn"); }
  });
  $("downloadJson").addEventListener("click", ()=>{
    const blob = new Blob([$("jsonOut").value||"{}"],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "video_analysis.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });
</script>
</body>
</html>